<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>fabricjs@5.x 红色小球飞入 + 导出带动画SVG</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Ubuntu, sans-serif;
        margin: 0;
        padding: 24px;
        background: #f5f5f5;
      }
      h1 {
        font-size: 20px;
        margin: 0 0 16px;
      }
      .toolbar {
        margin-bottom: 12px;
        display: flex;
        gap: 8px;
      }
      #c {
        border: 1px solid #ddd;
        background: #fff;
      }
      button {
        cursor: pointer;
        border: none;
        background: #1677ff;
        color: #fff;
        padding: 8px 14px;
        border-radius: 6px;
        font-size: 14px;
      }
      button:active {
        transform: scale(0.98);
      }
    </style>
  </head>
  <body>
    <h1>fabricjs动画 并导出 SVG动画文件</h1>
    <div class="toolbar">
      <button id="exportSvg">生成带动画的 SVG 文件</button>
      <!-- <button id="exportSvgStr">生成带动画的 SVG 文件</button> -->
    </div>
    <canvas id="c"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/fabric@5.2.1/dist/fabric.min.js"></script>
    <script src="./exportAnimatedSVG.js"></script>
    <script>
      const width = 600;
      const height = 300;

      const canvas = new fabric.Canvas("c", {
        width,
        height,
      });

      const textObj = new fabric.IText("商品价格标签", {
        left: 50,
        top: 50,
        fontSize: 30,
        fill: "#000",
        selectable: true,
        hasControls: true,
        hasBorders: false,
      });
      canvas.add(textObj);

      addTypingAnimation(textObj, {
        toText: "「你的店名」",
        speed: 200,
        pause: 1200,
      });

      function addTypingAnimation(
        textObj,
        { toText, speed = 150, pause = 1000 }
      ) {
        const fromText = textObj.text || "";
        let phase = "show_full";
        let charIndex = 0;
        let displayText = "";
        let cursorVisible = true;
        let timer = null;
        let blinkTimer = null;

        // 启动光标闪烁
        blinkTimer = setInterval(() => {
          cursorVisible = !cursorVisible;
          renderText();
        }, 500);

        function renderText() {
          textObj.text = displayText + (cursorVisible ? "|" : "");
          textObj.dirty = true;
          textObj.canvas?.requestRenderAll();
        }

        function loop() {
          if (phase === "show_full") {
            displayText = fromText;
            charIndex = fromText.length;
            renderText();
            timer = setTimeout(() => {
              phase = "deleting";
              loop();
            }, pause);
          } else if (phase === "deleting") {
            if (charIndex > 0) {
              charIndex--;
              displayText = fromText.slice(0, charIndex);
              renderText();
              timer = setTimeout(loop, speed);
            } else {
              phase = "typing";
              charIndex = 0;
              timer = setTimeout(loop, speed);
            }
          } else if (phase === "typing") {
            if (charIndex < toText.length) {
              charIndex++;
              displayText = toText.slice(0, charIndex);
              renderText();
              timer = setTimeout(loop, speed);
            } else {
              phase = "waiting";
              timer = setTimeout(() => {
                phase = "show_full";
                loop();
              }, pause);
            }
          }
        }

        function stop() {
          clearInterval(blinkTimer);
          clearTimeout(timer);
        }

        textObj.stopAnimation = stop;
        textObj.animateText = true;
        loop();
      }
    </script>
  </body>
</html>
