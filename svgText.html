<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>SVG.js æ— é™å¾ªç¯æ‰“å­—é€€æ ¼åŠ¨ç”»</title>
    <script src="https://cdn.jsdelivr.net/npm/gif.js.optimized/dist/gif.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fabric@5.2.1/dist/fabric.min.js"></script>
    <style>
      canvas {
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <button id="export">å¯¼å‡º</button>
    <div id="drawing"></div>

    <canvas id="c" width="600" height="600"></canvas>
    <button onclick="startRecordingTyping()">å¯¼å‡ºæ‰“å­—åŠ¨ç”» GIF</button>

    <script>
      const canvas = new fabric.Canvas("c", {
        backgroundColor: "#fff",
      });

      // åˆ›å»ºæ–‡å­—å¯¹è±¡
      const textObj = new fabric.Text("", {
        left: 50,
        top: 40,
        fontSize: 32,
        fill: "#000",
      });
      canvas.add(textObj);

      // æ‰“å­—åŠ¨ç”»å‡½æ•°ï¼ˆç•¥æœ‰ä¿®æ”¹ä»¥æ·»åŠ  hook å›è°ƒï¼‰
      function addTypingAnimation(
        textObj,
        { toText, speed = 150, pause = 1000, onFrame, onComplete }
      ) {
        const fromText = textObj.text || "";
        textObj.originalText = fromText;
        let phase = "show_full";
        let charIndex = 0;
        let displayText = "";
        let cursorVisible = true;
        let timer = null;
        let blinkTimer = null;
        let isCompleted = false;

        // å¯åŠ¨å…‰æ ‡é—ªçƒ
        blinkTimer = setInterval(() => {
          cursorVisible = !cursorVisible;
          renderText();
        }, 500);

        function renderText() {
          textObj.text = displayText + (cursorVisible ? "|" : "");
          textObj.dirty = true;
          textObj.canvas && textObj.canvas.requestRenderAll();
          if (onFrame) onFrame(); // ğŸ‘ˆ æ¯å¸§è°ƒç”¨ï¼Œé€šçŸ¥ gif.js æ•æ‰
        }

        function loop() {
          if (phase === "show_full") {
            displayText = fromText;
            charIndex = fromText.length;
            renderText();
            timer = setTimeout(() => {
              phase = "deleting";
              loop();
            }, pause);
          } else if (phase === "deleting") {
            if (charIndex > 0) {
              charIndex--;
              displayText = fromText.slice(0, charIndex);
              renderText();
              timer = setTimeout(loop, speed);
            } else {
              phase = "typing";
              charIndex = 0;
              timer = setTimeout(loop, speed);
            }
          } else if (phase === "typing") {
            if (charIndex < toText.length) {
              charIndex++;
              displayText = toText.slice(0, charIndex);
              renderText();
              timer = setTimeout(loop, speed);
            } else {
              if (!isCompleted) {
                isCompleted = true;
                clearInterval(blinkTimer);
                clearTimeout(timer);
                if (onComplete) onComplete(); // ğŸ‘ˆ åŠ¨ç”»å®Œæˆé€šçŸ¥
              }
            }
          }
        }

        textObj.stopAnimate = () => {
          clearInterval(blinkTimer);
          clearTimeout(timer);
          textObj.text = textObj.originalText;
          textObj.dirty = true;
          textObj.animatText = "";
          textObj.canvas && textObj.canvas.requestRenderAll();
        };

        textObj.animatText = toText;
        loop();
      }

      // âºï¸ å¯¼å‡ºåŠ¨ç”»
      async function startRecordingTyping() {
        const gif = new GIF({
          workers: 2,
          quality: 10,
          width: canvas.getWidth(),
          height: canvas.getHeight(),
          workerScript:
            "https://cdn.jsdelivr.net/npm/gif.js.optimized/dist/gif.worker.js",
        });

        // æ¯å¸§é‡‡é›† canvas å›¾åƒ
        const onFrame = () => {
          gif.addFrame(canvas.getElement(), { delay: 150 }); // æ¯å¸§150ms
        };

        // åŠ¨ç”»å®Œæˆæ—¶å¯¼å‡º
        const onComplete = () => {
          gif.on("finished", function (blob) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "typing.gif";
            a.click();
            URL.revokeObjectURL(url);
          });
          gif.render();
        };

        addTypingAnimation(textObj, {
          toText: "ä½ å¥½ï¼Œä¸–ç•Œï¼",
          speed: 150,
          pause: 1000,
          onFrame,
          onComplete,
        });
      }
    </script>
  </body>
</html>
