<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8" />
    <title>clipPath é®ç½©ç¤ºä¾‹ï¼ˆæ”¯æŒæ›²çº¿ Pathï¼‰</title>
    <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        margin: 12px;
      }
      canvas {
        border: 1px solid #ddd;
        display: block;
        margin-bottom: 8px;
      }
      .controls {
        margin-bottom: 8px;
      }
      button {
        margin-right: 6px;
      }
      label {
        margin-right: 8px;
      }
    </style>
  </head>
  <body>
    <div class="controls">
      <button id="rect">çŸ©å½¢é®ç½©</button>
      <button id="rrect">åœ†è§’çŸ©å½¢é®ç½©</button>
      <button id="circle">åœ†å½¢é®ç½©</button>
      <button id="curve">æ›²çº¿è·¯å¾„é®ç½©ï¼ˆè´å¡å°”ï¼‰</button>
      <label
        ><input id="showMaskVis" type="checkbox" checked />
        æ˜¾ç¤ºé®ç½©ï¼ˆè°ƒè¯•ç”¨ï¼‰</label
      >
    </div>

    <canvas id="c" width="1000" height="600"></canvas>

    <script>
      const canvas = new fabric.Canvas("c", { preserveObjectStacking: true });

      // ä¸€å¼ èƒŒæ™¯å›¾ç‰‡ï¼ˆä½œä¸ºè¢«é®ç½©çš„å†…å®¹ï¼‰
      let imgObj = null;
      fabric.Image.fromURL("https://fabricjs.com/assets/pug.jpg", (img) => {
        img.set({
          left: 120,
          top: 60,
          scaleX: 0.95,
          scaleY: 0.95,
        });
        canvas.add(img);
        imgObj = img;
        canvas.setActiveObject(img);
        canvas.requestRenderAll();
      });

      // å…¨ç”»å¸ƒçš„åŠé€æ˜è¦†ç›–å±‚ï¼ˆæˆ‘ä»¬ä¼šå¯¹å®ƒè®¾ç½® clipPathï¼‰
      const dimRect = new fabric.Rect({
        left: 0,
        top: 0,
        width: canvas.width,
        height: canvas.height,
        fill: "rgba(0,0,0,0.45)",
        selectable: false,
        evented: false,
      });
      canvas.add(dimRect);
      dimRect.moveTo(
        canvas.getHeight
          ? canvas.getObjects().length - 1
          : canvas.getObjects().length - 1
      );

      // å½“å‰é®ç½©å¯¹è±¡ï¼ˆæˆ‘ä»¬ä¼šæŠŠå®ƒæ·»åŠ åˆ° canvasï¼Œå¹¶æŠŠ dimRect.clipPath æŒ‡å‘å®ƒï¼‰
      let currentMask = null;

      // å·¥å…·ï¼šæŠŠæŸä¸ªå½¢çŠ¶è®¾ä¸ºå½“å‰é®ç½©å¹¶ç»‘å®šåˆ° dimRect.clipPath
      function useMask(mask) {
        // ä¿è¯é®ç½©åœ¨ canvas ä¸­ï¼ˆåªæ·»åŠ ä¸€æ¬¡ï¼‰
        if (!canvas.contains(mask)) {
          canvas.add(mask);
        }
        // æ˜¾ç¤º/äº‹ä»¶ä½¿èƒ½ï¼Œä¾¿äºæ‹–æ‹½/ç¼©æ”¾/æ—‹è½¬
        mask.selectable = true;
        mask.evented = true;
        mask.hasBorders = true;
        mask.hasControls = true;

        // clipPath ä½¿ç”¨ç»å¯¹å®šä½ï¼Œè¿™æ ·é®ç½©åœ¨ canvas ä¸Šç§»åŠ¨ä¼šè¢«æ­£ç¡®è¯†åˆ«
        mask.absolutePositioned = true;

        // å°† dimRect çš„ clipPath è®¾ç½®ä¸ºè¯¥å¯¹è±¡çš„å¼•ç”¨
        dimRect.clipPath = mask;
        // inverted=true è¡¨ç¤ºâ€œåå‘è£å‰ªâ€: dimRect æ˜¾ç¤ºåœ¨ mask ä¹‹å¤–ï¼Œmask å†…éƒ¨å½¢æˆé€å­”ã€‚
        dimRect.clipPath.inverted = true;
        // æŠŠ dimRect æ”¾åœ¨æœ€ä¸Šå±‚ï¼ˆç›–åœ¨å›¾ç‰‡ä¸Šï¼‰
        dimRect.bringToFront();
        // æŠŠé®ç½©æ˜¾ç¤ºåœ¨ dimRect ä¹‹ä¸Šï¼ˆä»¥ä¾¿å¯ç¼–è¾‘ï¼‰ã€‚ä¸ºäº†è®©é®ç½©å¯è§ï¼Œå®ƒéœ€è¦åœ¨ dimRect çš„ä¸Šæ–¹
        mask.bringToFront();

        currentMask = mask;
        canvas.requestRenderAll();
      }

      // åˆ›å»ºå‡ ç§é®ç½©ï¼ˆRect / åœ†è§’çŸ©å½¢ / Circle / T / æ›²çº¿è·¯å¾„ï¼‰
      function createRectMask() {
        return new fabric.Rect({
          left: 300,
          top: 120,
          width: 400,
          height: 300,
          fill: "rgba(255,255,255,0.6)",
          stroke: "#999",
          strokeWidth: 1,
          selectable: true,
          evented: true,
          originX: "left",
          originY: "top",
        });
      }

      function createRRectMask() {
        // fabric.Rect æ”¯æŒ rx/ry via 'rx' property (fabric 5.x)
        return new fabric.Rect({
          left: 320,
          top: 140,
          width: 360,
          height: 280,
          rx: 30,
          ry: 30,
          fill: "rgba(255,255,255,0.6)",
          stroke: "#999",
          strokeWidth: 1,
          selectable: true,
          evented: true,
          originX: "left",
          originY: "top",
        });
      }

      function createCircleMask() {
        return new fabric.Circle({
          left: 380,
          top: 140,
          radius: 140,
          fill: "rgba(255,255,255,0.6)",
          stroke: "#999",
          strokeWidth: 1,
          selectable: true,
          evented: true,
          originX: "left",
          originY: "top",
        });
      }

      function createCurveMask() {
        // æ›²çº¿ç¤ºä¾‹ï¼šä¸€ä¸ªç”¨è´å¡å°”æ›²çº¿ç»˜åˆ¶çš„ä¸è§„åˆ™é—­åˆè·¯å¾„ï¼ˆçœ‹èµ·æ¥åƒä¸€ä¸ªæ°´æ»´/å¶å­ï¼‰
        // M -> C -> C -> Zï¼Œä¿æŒæ›²çº¿æ®µå­˜åœ¨ä»¥æµ‹è¯•æ›²çº¿è£å‰ª
        const curvePath =
          "M 100 0 C 160 0 200 40 200 100 C 200 160 140 210 100 240 C 60 210 0 160 0 100 C 0 40 40 0 100 0 Z";
        return new fabric.Path(curvePath, {
          left: 360,
          top: 120,
          scaleX: 1,
          scaleY: 1,
          fill: "rgba(255,255,255,0.6)",
          stroke: "#999",
          strokeWidth: 1,
          selectable: true,
          evented: true,
          originX: "left",
          originY: "top",
        });
      }

      // åˆå§‹ä½¿ç”¨ T å½¢
      const tMask = createCurveMask();
      useMask(tMask);

      // ç»‘å®šæŒ‰é’®åˆ‡æ¢
      document
        .getElementById("rect")
        .addEventListener("click", () => useMask(createRectMask()));
      document
        .getElementById("rrect")
        .addEventListener("click", () => useMask(createRRectMask()));
      document
        .getElementById("circle")
        .addEventListener("click", () => useMask(createCircleMask()));
      document
        .getElementById("curve")
        .addEventListener("click", () => useMask(createCurveMask()));

      // åˆ‡æ¢é®ç½©æ˜¯å¦å¯è§ï¼ˆdebug æ—¶çœ‹å½¢çŠ¶è¾¹ç•Œï¼‰
      document
        .getElementById("showMaskVis")
        .addEventListener("change", (ev) => {
          const show = ev.target.checked;
          console.log("ğŸš€ ~ show=>", show);
          if (currentMask) {
            currentMask.set("opacity", show ? 1 : 0); // éšè—å¡«å……/è¾¹ç•Œï¼Œä»…ä¿ç•™å­”æ´æ•ˆæœ
            currentMask.set("selectable", show); // å¦‚æœéšè—ä¹Ÿå¯ä»¥æŠŠå®ƒè®¾ä¸ºä¸å¯é€‰
          }
          canvas.requestRenderAll();
        });

      // å°æç¤ºï¼šç§»åŠ¨/ç¼©æ”¾/æ—‹è½¬é®ç½©ä¼šè‡ªåŠ¨æ›´æ–° dimRect çš„ç©¿å­”æ•ˆæœï¼ˆå› ä¸º clipPath.absolutePositioned = true å¹¶ä¸”ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼‰ã€‚
      // ä½ ä¹Ÿå¯ä»¥ç§»åŠ¨èƒŒæ™¯å›¾åƒæœ¬èº«ï¼Œé®ç½©ä»ç„¶æŒ‰ canvas åæ ‡å»ºç«‹â€œé€å­”â€ï¼Œæ•ˆæœä¸€è‡´ã€‚

      // åœ¨äº¤äº’ä¸­ä¿æŒ dimRect è¦†ç›–åœ¨æœ€ä¸Šé¢ï¼ˆé¿å…è¢«é®ç½©å¯¹è±¡é®ç›–ï¼‰
      canvas.on("object:modified", () => {
        if (dimRect) dimRect.bringToFront();
        if (currentMask) currentMask.bringToFront();
        canvas.requestRenderAll();
      });

      canvas.on("object:moving", () => {
        if (dimRect) dimRect.bringToFront();
        if (currentMask) currentMask.bringToFront();
      });

      // é˜²æ­¢è¯¯é€‰åˆ° dimRect
      dimRect.selectable = false;
      dimRect.evented = false;
    </script>
  </body>
</html>
