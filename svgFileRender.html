<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fabric.js SVG Upload Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/jquery.json-viewer/json-viewer/jquery.json-viewer.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/jquery.json-viewer/json-viewer/jquery.json-viewer.js"></script>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        font-size: 14px;
      }
      .container {
        display: flex;
        height: 100vh;
      }
      .left,
      .right {
        padding: 16px;
        box-sizing: border-box;
        overflow-x: hidden;
      }
      .left {
        width: 650px;
        display: flex;
        flex-direction: column;
      }
      .right {
        flex: 1;
        border-left: 1px solid #ccc;
        background-color: #f9f9f9;
        overflow-x: hidden;
        padding: 30px 0;
      }
      canvas {
        border: 1px solid #ccc;
      }
      .canvas-container {
        flex-shrink: 0;
      }
      #jsonViewer {
        height: calc(100% - 20px);
      }
      kbd {
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
        margin: 0 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="left">
        <div class="controls">
          <h2>ä½¿ç”¨Fabric.jsæ¸²æŸ“SVGæ–‡ä»¶å¹¶è·å–JSONæ•°æ®</h2>
          <p>
            <input type="file" id="svgInput" accept="image/svg+xml" />
            <span id="svgSize"></span>
          </p>
          <p>
            <button type="button" id="getJsonData">è·å–JSONæ•°æ®</button>
            <button type="button" id="getActiveElementJsonData">
              è·å–å½“å‰å…ƒç´ JSONæ•°æ®
            </button>
            <span id="jsonSize" style="color: red"></span>
          </p>
        </div>
        <div style="display: flex; gap: 20px; margin-bottom: 20px">
          <button id="resetBtn">é‡ç½®ç”»å¸ƒ</button>
          <button id="selectAllBtn">å…¨é€‰å…ƒç´ </button>
        </div>
        <div style="margin-bottom: 10px">
          åˆ é™¤ï¼š<kbd>Backspace</kbd>/<kbd>Del</kbd>
        </div>
        <div style="margin-bottom: 10px">æ’¤é”€ï¼š<kbd>ctrl+Z</kbd></div>
        <div style="margin-bottom: 10px">
          é‡åšï¼š<kbd>Ctrl+Y</kbd>/<kbd>Ctrl+Shift+Z</kbd>
        </div>
        <div style="margin-bottom: 20px">å…¨é€‰å…ƒç´ ï¼š<kbd>Ctrl+A</kbd></div>

        <canvas id="canvas" width="600" height="500"></canvas>
        <h2>æ•°æ®éœ€è¦å¤„ç†çš„ç‚¹ï¼š</h2>
        <h3>1.JSONæ•°æ®è½¬æ¢æ ¡éªŒ</h3>
        <p>
          æ ¡éªŒsvgä¸­çš„æ–‡æ¡ˆæ˜¯å¦æ˜¯æ­£ç¡®çš„ï¼Œè¦æ’é™¤å›¾åƒæ–‡æ¡ˆï¼Œå› ä¸ºå›¾åƒæ–‡æ¡ˆåœ¨å®¢æˆ·ç«¯æ˜¯æ— æ³•è°ƒèµ·é”®ç›˜ç¼–è¾‘
        </p>
        <h3>2.å¤„ç†svgä¸­çš„base64å›¾ç‰‡</h3>
        <p>
          svgä¸­çš„base64å›¾ç‰‡ä¼šä½¿jsonæ•°æ®å¾ˆå¤§ï¼Œåœ¨æ•°æ®ä¼ è¾“æ—¶æ¯”è¾ƒæ…¢ï¼Œè€Œä¸”ç°åœ¨ä¹Ÿä¸æ”¯æŒbase64æ¸²æŸ“ï¼Œè¦ä¸Šä¼ åˆ°ossè½¬æˆsrcï¼Œç„¶åèµ‹å€¼ç»™å…ƒç´ çš„src_urlå±æ€§
        </p>
        <h3>3.å¢åŠ æœ€å¤–å±‚å¿…è¦æ•°æ®</h3>
        <p>å¢åŠ å®½é«˜ï¼Œä»¥åŠèƒŒæ™¯é¢œè‰²ï¼Œæè´¨èƒ½å¿…é¡»è¦æœ‰çš„ä¿¡æ¯ï¼Œè®©å®¢æˆ·ç«¯èƒ½æ­£ç¡®æ¸²æŸ“</p>
      </div>
      <div class="right">
        <div id="jsonViewer"></div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/jquery.json-viewer/json-viewer/jquery.json-viewer.js"></script>
    <script>
      const canvas = new fabric.Canvas("canvas");

      window.canvas = canvas;

      let initialSVGState = null; // ç”¨äºä¿å­˜ç¬¬ä¸€æ¬¡åŠ è½½åçš„ SVG JSON çŠ¶æ€
      let isRestoring = false; // æ ‡å¿—ï¼šå½“å‰æ˜¯å¦å¤„äºæ’¤é”€/é‡åšä¸­

      $("#svgInput").change(function (event) {
        const file = event.target.files[0];
        if (!file || file.type !== "image/svg+xml") {
          alert("Please upload a valid SVG file.");
          return;
        }
        const reader = new FileReader();
        reader.onload = function (e) {
          $("#svgSize").text(
            "SVGæ–‡ä»¶å¤§å°:" + (file.size / 1024 / 1024).toFixed(2) + "MB"
          );
          const svgText = e.target.result;
          canvas.clear();

          fabric.loadSVGFromString(svgText, (objects, options) => {
            canvas.clear();

            // éå†æ¯ä¸ªå¯¹è±¡ï¼Œè®¾ç½®å…¶ä¸ºå¯ç¼–è¾‘
            objects.forEach((obj) => {
              obj.set({
                selectable: true,
                hasControls: true,
                lockScalingFlip: false,
                lockMovementX: false,
                lockMovementY: false,
                lockScalingX: false,
                lockScalingY: false,
                lockRotation: false,
                editable: true, // è™½ç„¶ Fabric æœ¬èº«ä¸ä½¿ç”¨ editable å±æ€§ï¼Œä½†å¦‚æœä½ æ‰©å±•ç¼–è¾‘å™¨å¯èƒ½ç”¨å¾—åˆ°
              });

              // å¯¹äºæ–‡æœ¬å¯¹è±¡ï¼Œç¡®ä¿å¯ç”¨ç¼–è¾‘
              if (obj.type === "text" || obj.type === "i-text") {
                const itext = new fabric.IText(obj.text, obj.toObject());
                canvas.add(itext);
              } else {
                canvas.add(obj);
              }
            });
            canvas.requestRenderAll();
            saveState();
            // ä¿å­˜åˆå§‹ SVG çŠ¶æ€ç”¨äºé‡ç½®
            initialSVGState = JSON.stringify(canvas.toJSON());
          });
        };
        reader.readAsText(file);
      });

      // ç›‘å¬æ“ä½œè¡Œä¸ºåè‡ªåŠ¨ä¿å­˜å¿«ç…§ï¼ˆç§»åŠ¨ã€ç¼©æ”¾ã€æ—‹è½¬ã€ä¿®æ”¹æ–‡å­—ç­‰ï¼‰
      canvas.on("object:modified", () => {
        saveState();
        redoStack.length = 0; // ä¿®æ”¹åæ¸…é™¤ redo æ ˆ
      });

      // canvas.on("object:removed", () => {
      //   saveState();
      //   redoStack.length = 0;
      // });

      const undoStack = [];
      const redoStack = [];
      // åˆ é™¤é€‰ä¸­å¯¹è±¡ï¼ˆç›‘å¬é”®ç›˜ Delete æˆ– Backspaceï¼‰
      document.addEventListener("keydown", function (e) {
        if (e.key === "Delete" || e.key === "Backspace") {
          const activeObject = canvas.getActiveObject();
          if (activeObject) {
            // åˆ é™¤ç»„æˆ–å•ä¸ªå¯¹è±¡
            if (activeObject.type === "activeSelection") {
              activeObject.forEachObject((obj) => canvas.remove(obj));
            } else {
              canvas.remove(activeObject);
            }
            canvas.discardActiveObject();
            canvas.requestRenderAll();
            // âœ… æ˜ç¡®åœ¨ç”¨æˆ·æ“ä½œâ€œå®Œæˆâ€åè°ƒç”¨ saveStateï¼Œåªä¿å­˜æœ‰æ„ä¹‰çš„ä¸€æ¬¡å˜æ›´
            saveState();
          }
        }
        // æ’¤é”€ Ctrl+Z
        if ((e.ctrlKey || e.metaKey) && e.key === "z") {
          console.log("ğŸš€ ~ undoStack=>", undoStack);
          if (undoStack.length > 1) {
            const currentState = undoStack.pop();
            console.log("ğŸš€ ~ undoStack=>", undoStack);
            redoStack.push(currentState);
            const prevState = undoStack[undoStack.length - 1];
            restoreState(prevState);
          }
        }

        // é‡åš Ctrl+Y æˆ– Ctrl+Shift+Z
        if (
          (e.ctrlKey || e.metaKey) &&
          (e.key === "y" || (e.shiftKey && e.key === "Z"))
        ) {
          if (redoStack.length > 0) {
            const nextState = redoStack.pop();
            undoStack.push(nextState);
            restoreState(nextState);
          }
        }

        // å…¨é€‰ Ctrl+A
        if ((e.ctrlKey || e.metaKey) && e.key === "a") {
          e.preventDefault();
          const allObjects = canvas.getObjects();
          if (allObjects.length > 0) {
            const selection = new fabric.ActiveSelection(allObjects, {
              canvas: canvas,
            });
            canvas.setActiveObject(selection);
            canvas.requestRenderAll();
          }
        }
      });
      // è®°å½•å½“å‰ç”»å¸ƒçŠ¶æ€
      function saveState() {
        if (isRestoring) return; // é¿å…åœ¨æ’¤é”€/é‡åšä¸­ä¿å­˜çŠ¶æ€
        const json = JSON.stringify(canvas.toJSON());

        // é¿å…é‡å¤çŠ¶æ€ï¼ˆä¸¤æ¬¡çŠ¶æ€å®Œå…¨ä¸€æ ·æ—¶ä¸å…¥æ ˆï¼‰
        if (
          undoStack.length === 0 ||
          undoStack[undoStack.length - 1] !== json
        ) {
          if (undoStack.length >= 50) undoStack.shift();
          undoStack.push(json);
          redoStack.length = 0; // ä¸€æ—¦ç”¨æˆ·æ–°æ“ä½œï¼Œæ¸…ç©º redo æ ˆ
        }
      }

      // æ¢å¤å†å²çŠ¶æ€
      function restoreState(json) {
        isRestoring = true;
        canvas.loadFromJSON(json, () => {
          canvas.renderAll();
          isRestoring = false;
        });
      }

      // é‡ç½®æŒ‰é’®ï¼šæ¢å¤åˆå§‹ SVG çŠ¶æ€
      document.getElementById("resetBtn").addEventListener("click", () => {
        console.log("ğŸš€ ~ initialSVGState=>", initialSVGState);
        if (initialSVGState) {
          canvas.loadFromJSON(initialSVGState, () => {
            canvas.renderAll();
            saveState();
          });
        } else {
          alert("å°šæœªåŠ è½½ä»»ä½•SVGæ–‡ä»¶ï¼");
        }
      });

      // å…¨é€‰æŒ‰é’®ï¼šé€‰ä¸­æ‰€æœ‰å…ƒç´ 
      document.getElementById("selectAllBtn").addEventListener("click", () => {
        const allObjects = canvas.getObjects();
        if (allObjects.length > 0) {
          const selection = new fabric.ActiveSelection(allObjects, {
            canvas: canvas,
          });
          canvas.setActiveObject(selection);
          canvas.requestRenderAll();
        }
      });

      document
        .getElementById("getActiveElementJsonData")
        .addEventListener("click", () => {
          const activeObject = canvas.getActiveObject();

          if (!activeObject) {
            alert("å½“å‰æ²¡æœ‰é€‰ä¸­ä»»ä½•å…ƒç´ ï¼");
            return;
          }

          let jsonData;

          if (activeObject.type === "activeSelection") {
            // å¤šé€‰æ—¶ï¼šè½¬æ¢æˆå•ä¸ªå¯¹è±¡æ•°ç»„
            jsonData = activeObject._objects.map((obj) => obj.toJSON());
          } else {
            // å•ä¸ªå…ƒç´ 
            jsonData = activeObject.toJSON();
          }

          console.log("å½“å‰å…ƒç´  JSON æ•°æ®ï¼š", jsonData);

          // å¦‚æœä½ æœ‰ä¸€ä¸ªæŸ¥çœ‹å™¨å®¹å™¨ï¼Œä¾‹å¦‚ id="jsonViewer"
          $("#jsonViewer").jsonViewer(jsonData, {
            collapsed: false,
            rootCollapsable: true,
          });

          // ä¹Ÿå¯ä»¥æ˜¾ç¤º JSON æ•°æ®å¤§å°
          const jsonDataSize = JSON.stringify(jsonData).length;
          $("#jsonSize").text(
            "å½“å‰å…ƒç´  JSON å¤§å°:" +
              (jsonDataSize / 1024 / 1024).toFixed(2) +
              "MB"
          );
        });

      $("#getJsonData").click(function () {
        const jsonData = canvas.toJSON();
        // è®¡ç®—jsonæ•°æ®å¤§å°
        const jsonDataSize = JSON.stringify(jsonData).length;
        $("#jsonSize").text(
          "JSONæ•°æ®å¤§å°:" + (jsonDataSize / 1024 / 1024).toFixed(2) + "MB"
        );
        $("#jsonViewer").jsonViewer(jsonData, {
          collapsed: false,
          rootCollapsable: true,
        });
      });
    </script>
  </body>
</html>
